# .github/workflows/build.yml

name: CI Build

on:
  pull_request:
    branches: ['*']
  push:
    branches: [main]

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:

  compile-check:
    name: "üîç Compile Check"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Ensure Gradle wrapper exists
        run: |
          if [ ! -f "./gradlew" ]; then
            echo "::warning::gradlew not found ‚Äî generating wrapper"
            gradle wrapper --gradle-version=8.11.1
            chmod +x ./gradlew
          fi

      - name: Install required Android SDK components
        run: |
          echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
            --licenses > /dev/null 2>&1 || true
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
            "platforms;android-36" \
            "build-tools;36.0.0"

      - name: Compile shared module
        run: ./gradlew shared:compileDebugKotlinAndroid shared:compileKotlinDesktop --no-daemon

      - name: Compile Android app
        run: ./gradlew androidApp:compileDebugKotlin --no-daemon

      - name: Compile Desktop app
        run: ./gradlew desktopApp:compileKotlin --no-daemon

  build-android:
    name: "üì± Build Android APK"
    needs: compile-check
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Ensure Gradle wrapper exists
        run: |
          if [ ! -f "./gradlew" ]; then
            echo "::warning::gradlew not found ‚Äî generating wrapper"
            gradle wrapper --gradle-version=8.11.1
            chmod +x ./gradlew
          fi

      - name: Install required Android SDK components
        run: |
          echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
            --licenses > /dev/null 2>&1 || true
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
            "platforms;android-36" \
            "build-tools;36.0.0"

      - name: Build debug APK
        run: ./gradlew androidApp:assembleDebug --no-daemon

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: lanbridge-android-debug
          path: androidApp/build/outputs/apk/debug/*.apk
          retention-days: 30
          if-no-files-found: error

  build-desktop-linux:
    name: "üêß Build Desktop (Linux)"
    needs: compile-check
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Ensure Gradle wrapper exists
        run: |
          if [ ! -f "./gradlew" ]; then
            echo "::warning::gradlew not found ‚Äî generating wrapper"
            gradle wrapper --gradle-version=8.11.1
            chmod +x ./gradlew
          fi

      - name: Build uber JAR
        run: ./gradlew desktopApp:packageUberJarForCurrentOS --no-daemon

      - name: Upload Linux JAR
        uses: actions/upload-artifact@v4
        with:
          name: lanbridge-desktop-linux
          path: desktopApp/build/compose/jars/*.jar
          retention-days: 30
          if-no-files-found: error

      - name: Build .deb package
        run: ./gradlew desktopApp:packageDeb --no-daemon
        continue-on-error: true

      - name: Upload .deb package
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: lanbridge-desktop-linux-deb
          path: desktopApp/build/compose/binaries/main/deb/*.deb
          retention-days: 30
          if-no-files-found: ignore

  build-desktop-windows:
    name: "ü™ü Build Desktop (Windows)"
    needs: compile-check
    runs-on: windows-latest
    timeout-minutes: 25
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Ensure Gradle wrapper exists
        shell: bash
        run: |
          if [ ! -f "./gradlew.bat" ]; then
            echo "::warning::gradlew.bat not found ‚Äî generating wrapper"
            gradle wrapper --gradle-version=8.11.1
            chmod +x ./gradlew
          fi

      - name: Build uber JAR
        run: ./gradlew desktopApp:packageUberJarForCurrentOS --no-daemon

      - name: Upload Windows JAR
        uses: actions/upload-artifact@v4
        with:
          name: lanbridge-desktop-windows
          path: desktopApp/build/compose/jars/*.jar
          retention-days: 30
          if-no-files-found: error

      - name: Build .msi installer
        run: ./gradlew desktopApp:packageMsi --no-daemon
        continue-on-error: true

      - name: Upload .msi installer
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: lanbridge-desktop-windows-msi
          path: desktopApp/build/compose/binaries/main/msi/*.msi
          retention-days: 30
          if-no-files-found: ignore

  build-status:
    name: "‚úÖ Build Status"
    if: always()
    needs: [build-android, build-desktop-linux, build-desktop-windows]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Check all builds passed
        run: |
          echo "Android:  ${{ needs.build-android.result }}"
          echo "Linux:    ${{ needs.build-desktop-linux.result }}"
          echo "Windows:  ${{ needs.build-desktop-windows.result }}"

          if [[ "${{ needs.build-android.result }}" == "failure" ]] || \
             [[ "${{ needs.build-desktop-linux.result }}" == "failure" ]] || \
             [[ "${{ needs.build-desktop-windows.result }}" == "failure" ]]; then
            echo "‚ùå One or more builds failed!"
            exit 1
          fi

          echo "‚úÖ All builds passed!"